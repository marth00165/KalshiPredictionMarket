# KalshiMarketPredictor Handoff - 2026-02-24

## Purpose
Carry forward exact context for next Codex session with minimal re-discovery.

## Completed Work (Recent)
- `282950c`: improved Elo score.
- `5aba0db`: deterministic injury impact pipeline + cache.
- `0b9bbe4`: shared NBA Elo analyzer helpers.
- `d2ff98e`: offline Elo artifact generation + param-based cache refresh.
- `621a303`: live injury data integration update.
- `bd44260`: SportsRadar injury refresh optimized to slate-scoped, on-demand profiles.
- `6cd34d3`: fee-aware shadow decision engine + JSONL attribution logging.
- `cca02ad`: SportsRadar injury pipeline optimization with game-key cache and profile TTL controls.

## New Change Implemented This Session (Not Yet Committed)
Goal: limit injury scans to current date only.

Files updated:
- `app/analysis/injury_llm_cache.py`
- `app/analysis/openai_analyzer.py`
- `app/analysis/claude_analyzer.py`

Behavior added:
- New helper `is_market_for_current_date(...)` in injury service.
- For NBA markets outside current UTC date, analyzers now skip injury refresh/profile calls and return Elo-only fallback with:
  - `llm_source_tag = "date_filtered_no_scan"`
  - reason: `outside_current_date_injury_scan_window`

## Dry-Run Evidence
### Cycle 71 (before date filter)
Report: `reports/dry_run_analysis/cycle_0071_20260224T095249Z.json`
- `pim_refresh`: 13
- `cached`: 2
- `rate_limited_no_cache`: 19

### Cycle 72 (after date filter)
Report: `reports/dry_run_analysis/cycle_0072_20260224T095938Z.json`
- `date_filtered_no_scan`: 12
- `pim_refresh`: 2
- `cached`: 4
- `rate_limited_no_cache`: 16

Interpretation:
- Non-today markets are now correctly excluded from injury scans.
- SportsRadar 429 still occurs on some today markets (likely burst/window/IP throttle on profile endpoints).

## What Is Still Pending Testing
1. Re-run tomorrow with fresh SportsRadar window and confirm lower 429 rate.
2. Verify today-only gating remains correct when Kalshi slate includes mixed dates.
3. Confirm no behavioral drift in Claude path (same date-gating behavior as OpenAI).
4. Confirm cache effectiveness with warm run:
   - increase in `cached`
   - stable/low `pim_refresh`
   - reduced `rate_limited_no_cache`
5. Validate that opportunities/signal counts remain expected after gating.

## Run Commands for Tomorrow
### Standard dry run
```bash
python -m app --mode trade --once --dry-run --skip-setup-wizard --non-interactive
```

### Quick source-tag breakdown
```bash
jq -r '.results[]?.elo_adjustment?.llm_source_tag // "unknown"' reports/dry_run_analysis/cycle_XXXX_*.json | sort | uniq -c
```

### Quick market-date split in report
```bash
jq -r '.results[].market_id' reports/dry_run_analysis/cycle_XXXX_*.json | awk -F- '{print $2}' | cut -c1-7 | sort | uniq -c
```

## Current Config Notes
- SportsRadar access level currently `trial`.
- Injury cache TTL config currently:
  - feed TTL: `3600s`
  - profile TTL: `14400s`
- Team profile budget window:
  - max team profiles: `12`
  - window: `120s`
- PIM bounds:
  - `pim_k_factor = 5`
  - `pim_max_delta = 30`

## Known Constraints / Risks
- Even with total call quota available, short-window burst limits can produce 429.
- Analyzer batch parallelism can still fan out profile requests for today markets.
- Fallback logic is safe (Elo-only) but reduces injury-driven differentiation when rate-limited.

## Working Tree Status Reminder
There are local modified/untracked files beyond this handoff doc. Review with:
```bash
git status --short
```

## Suggested Next Commit (for date gating)
If ready to keep today-only injury scan behavior:
```bash
git add app/analysis/injury_llm_cache.py app/analysis/openai_analyzer.py app/analysis/claude_analyzer.py HANDOFF_2026-02-24.md
git commit -m "Limit injury enrichment to current-date NBA markets and add handoff log"
```
